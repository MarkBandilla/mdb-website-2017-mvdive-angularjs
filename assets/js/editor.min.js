function listPage() {
    var a = $("#page .list-page"),
        e = $("#page .list-view");
    a.html(""), e.html("");
    for (var t = 0; t < database.pages.length; t++) {
        var d = database.pages[t],
            s = "";
        if (database.currentPage && database.currentPage._id == database.pages[t]._id && (s = "active", $(".main").html(database.pages[t].template), $(".main").bfeditor({
                snippetsUrl: "template/snippets.html",
                onContentChanged: function(a) {
                    for (var e = $(".main").bfeditor("getContent"), t = 0; t < database.pages.length; t++) database.currentPage._id == database.pages[t]._id && (database.pages[t].template = e)
                }
            })), "view" === d.type) {
            var l = '<li class="list-group-item ' + s + '"> <a href="#" class="page-item" data-index="' + d._id + '"><span class="' + d.icon + '"></span> ' + d.label + "</a></li>";
            e.append(l)
        } else {
            var l = '<li class="list-group-item ' + s + '"> <a href="#" class="page-item" data-index="' + d._id + '"><span class="' + d.icon + '"></span> ' + d.label + '</a> <span class="pull-right">   <button class="btn btn-default btn-xs" onclick="editPage(' + d._id + ')"><span class="fa fa-cog text-muted"></span></button>   <button class="btn btn-default btn-xs" onclick="clonePage(' + d._id + ')"><span class="fa fa-clone text-muted"></span></button>   <button class="btn btn-default btn-xs" onclick="deletePage(' + d._id + ')"><span class="fa fa-times text-muted"></span></button> </span></li>';
            a.append(l)
        }
    }
}

function addPage() {
    var a = {},
        e = database.pageSchema,
        t = database.pages.length - 1,
        d = 0;
    t >= 0 && (d = database.pages[t]._id + 1), $("#frm-page-editor").find('[name="action"]').val("add"), $("#frm-page-editor").find('[name="id"]').val(d), $("#mdl-page-editor .modal-body").html('<div style="padding:20px;">' + formBuilder(e, a) + "</div>"), $('#mdl-page-editor [type="submit"]').text("Add Page"), $("#mdl-page-editor").modal("show")
}

function editPage(a) {
    for (var e = 0, t = {}, d = database.pageSchema, s = 0; s < database.pages.length; s++) database.pages[s]._id == a && (t = database.pages[s], e = s, database.currentPage = t, "true" === t.show && (t.show = !0), "false" === t.show && (t.show = !1), $("#frm-page-editor").find('[name="action"]').val("update"), $("#frm-page-editor").find('[name="id"]').val(t._id), $("#mdl-page-editor .modal-body").html('<div style="padding:20px;">' + formBuilder(d, t) + "</div>"), $('#mdl-page-editor [type="submit"]').text("Update Page"), $("#mdl-page-editor").modal("show"))
}

function deletePage(a) {
    for (var e = "", t = 0; t < database.pages.length; t++)
        if (database.pages[t]._id == a) {
            e = database.pages[t].label;
            var d = window.confirm('You are about to remove "' + e + '" Page, this is undoable');
            d && (database.pages.splice(t, 1), listPage(), toastr.success(e + " Removed", "Success!"))
        }
}

function clonePage(a) {
    for (var e = {}, t = 0; t < database.pages.length; t++)
        if (database.pages[t]._id == a) {
            var d = prompt("New Page Name", database.pages[t].label),
                s = prompt("New Page Link", database.pages[t].link),
                l = prompt("New Page Icon", database.pages[t].icon);
            if (d) {
                var i = database.pages[database.pages.length - 1]._id + 1,
                    n = database.pages[t].template;
                e = {
                    _id: i,
                    label: d,
                    link: s,
                    icon: l,
                    template: n
                }, database.pages.push(e), toastr.success(d + " Cloned", "Success!")
            }
        }
    listPage()
}

function selectPage(a) {
    for (var e = 0; e < database.pages.length; e++) database.pages[e]._id == a && (database.currentPage = database.pages[e]);
    listPage()
}

function getViewTemplate(a) {
    a += "-view";
    for (var e = 0; e < database.pages.length; e++)
        if (database.pages[e].label.toLowerCase() === a.toLowerCase() && "view" === database.pages[e].type) return database.pages[e].template
}

function listDB() {
    var a = "",
        e = $("#database .list-db");
    e.html("");
    for (var t = 0; t < database.db.length; t++) {
        var d = database.db[t],
            s = "";
        a += '<li class="list-group-item ' + s + '"> <a href="#" class="db-item" data-index="' + d._id + '" onclick="editDB(' + d._id + ')">' + d.name + '</a> <span class="pull-right">   <button class="btn btn-default btn-xs" onclick="editDB(' + d._id + ')"><span class="fa fa-pencil text-muted"></span></button>   <button class="btn btn-default btn-xs" onclick="configDB(' + d._id + ')"><span class="fa fa-cog text-muted"></span></button>   <button class="btn btn-default btn-xs" onclick="deleteDB(' + d._id + ')"><span class="fa fa-times text-muted"></span></button> </span></li>'
    }
    e.html(a)
}
$(".btn-toggle").on("click", function() {
    var a = $(".sidebar"),
        e = $("body"),
        t = $(this).find("span");
    a.hasClass("nav-open") ? (a.removeClass("nav-open"), a.addClass("nav-close"), e.removeClass("nav-open"), e.addClass("nav-close"), t.removeClass("fa-chevron-left"), t.addClass("fa-chevron-right")) : (a.addClass("nav-open"), a.removeClass("nav-close"), e.addClass("nav-open"), e.removeClass("nav-close"), t.addClass("fa-chevron-left"), t.removeClass("fa-chevron-right"))
}), listPage(), $("#frm-page-editor").on("submit", function(a) {
    a.preventDefault();
    var e = $(this).find("[name]"),
        t = {};
    if (e.each(function() {
            t[this.name] = $(this).val()
        }), "add" === t.action) {
        if (t.label) {
            database.pages.push({
                _id: t.id,
                label: t.label,
                link: t.link,
                icon: t.icon,
                show: t.show,
                template: ""
            });
            for (var d = 0; d < database.pages.length; d++) database.pages[d]._id == t.id && (data = database.pages[d], database.currentPage = data);
            listPage(), $("#mdl-page-editor").modal("hide"), toastr.success(t.label + " Created", "Success!")
        }
    } else if ("update" === t.action)
        if (t.label) {
            for (var s = 0, d = 0; d < database.pages.length; d++) database.pages[d]._id == t.id && (data = database.pages[d], s = d, "true" === t.show && (t.show = !0), "false" === t.show && (t.show = !1));
            database.pages[s].label = t.label, database.pages[s].link = t.link, database.pages[s].icon = t.icon, database.pages[s].show = t.show, listPage(), $("#mdl-page-editor").modal("hide"), toastr.success(t.label + " Updated", "Success!")
        } else toastr.error("Page Update Canceled", "Failed!");
    console.log(t)
}), $(".sidebar .list-group").delegate(".page-item", "click", function() {
    var a = $(this).data("index");
    selectPage(a)
}), listDB(), $("#mdl-db-editor").delegate(".list-add", "click", function(a) {
    a.preventDefault();
    for (var e = {}, t = 0; t < database.db.length; t++) database.currentDB._id === database.db[t]._id && (e = database.db[t]);
    var d = {},
        s = e.collections.length;
    if (s) var l = e.collections[e.collections.length - 1]._id + 1;
    else var l = 1;
    d._id = l, $.each(e.schema, function(a, e) {
        "Image" === e.label ? d[e.label] = "data:image/gif;base64,R0lGODlhAQABAIAAAHd3dwAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" : d[e.label] = e.label
    }), d.vLink = "#/" + database.currentDB.name.toLowerCase() + "/" + l, e.collections.push(d), $("#mdl-db-editor .modal-body").html(formBuilder({
        type: "table",
        schema: e.schema
    }, e.collections))
}), $("#mdl-db-editor").delegate("[name]", "change", function() {
    for (var a = $(this).attr("name"), e = $(this).val(), t = parseInt($(this).closest("tr").attr("list-id")), d = {}, s = 0; s < database.db.length; s++) database.currentDB._id === database.db[s]._id && (d = database.db[s]);
    $.each(d.collections, function(d, s) {
        s._id === t && (s[a] = e)
    }), $("#mdl-db-editor .modal-body").html(formBuilder({
        type: "table",
        schema: d.schema
    }, d.collections))
}), $("body").delegate(".btn-richtext", "click", function(a) {
    a.preventDefault();
    var e = database.currentDB._id,
        t = parseInt($(this).closest("tr").attr("list-id")),
        d = $(this).attr("name");
    $("#frm-richtext").find('[name="dbId"]').val(e), $("#frm-richtext").find('[name="colId"]').val(t), $("#frm-richtext").find('[name="field"]').val(d);
    for (var s = {}, l = 0; l < database.db.length; l++) database.currentDB._id === database.db[l]._id && (s = database.db[l]);
    $.each(s.collections, function(a, e) {
        e._id === t && ($("#mdl-richtext-editor .modal-title").html("<b>" + s.name + " : " + e.Title + "</b>"), $("#summernote").summernote("code", e[d]))
    }), $("#mdl-db-editor").modal("hide"), $("#mdl-page-editor").modal("hide"), $("#mdl-record-editor").modal("hide"), $("#mdl-richtext-editor").modal("show")
}), $("#frm-richtext").on("submit", function(a) {
    a.preventDefault();
    for (var e = ($(this).find('[name="dbId"]').val(), parseInt($(this).find('[name="colId"]').val())), t = $(this).find('[name="field"]').val(), d = $("#summernote").summernote("code"), s = {}, l = 0; l < database.db.length; l++) database.currentDB._id === database.db[l]._id && (s = database.db[l]);
    $.each(s.collections, function(a, s) {
        s._id === e && (s[t] = d, $("#mdl-richtext-editor").modal("hide"), $("#mdl-db-editor").modal("show"), toastr.success("Record Updated", "Success!"))
    })
}), $("#frm-richtext").delegate(".btn-close", "click", function(a) {
    a.preventDefault(), $("#mdl-richtext-editor").modal("hide"), $("#mdl-db-editor").modal("show")
}), $("#mdl-db-editor").delegate(".list-delete", "click", function(a) {
    a.preventDefault();
    for (var e = {}, t = parseInt($(this).closest("tr").attr("list-id")), d = {}, s = 0; s < database.db.length; s++) database.currentDB._id === database.db[s]._id && (d = database.db[s]);
    $.each(d.collections, function(a, s) {
        if (s._id === t) {
            e = s;
            var l = window.confirm("Your about to delete , are you sure?");
            l && (d.collections = $.grep(d.collections, function(a) {
                return a._id != t
            }), $("#mdl-db-editor .modal-body").html(formBuilder({
                type: "table",
                schema: d.schema
            }, d.collections)))
        }
    })
}), $("#mdl-db-editor").delegate(".dp-chooser", "click", function() {
    for (var a = $(this), e = parseInt($(this).closest("tr").attr("list-id")), t = $(this).attr("key"), d = ($(this).val(), {}), s = 0; s < database.db.length; s++) database.currentDB._id === database.db[s]._id && (d = database.db[s]);
    dpChooser("image", function(s) {
        $(a).attr("src", s), $.each(d.collections, function(a, d) {
            d._id === e && (d[t] = s)
        }), $("#mdl-db-editor .modal-body").html(formBuilder({
            type: "table",
            schema: d.schema
        }, d.collections))
    })
}), $("body").delegate("[data-view-link]", "click", function() {
    var a = $(this).attr("href"),
        e = getDBSchema(a.split("/")[1]),
        t = getDBCollection(a.split("/")[1]),
        d = getDBRecord(t, a.split("/")[2]);
    $("#frm-record").find('[name="db"]').val(a.split("/")[1]), $("#frm-record").find('[name="_id"]').val(a.split("/")[2]), $("#frm-record .modal-body").html(""), $("#frm-record .modal-body").append(formBuilder(e, d)), $("#mdl-record-editor").modal("show")
});