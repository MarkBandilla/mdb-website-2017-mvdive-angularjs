function dpChooser(e, a) {
    if ("undefined" == typeof Dropbox) {
        var t = prompt("Please enter Image URL");
        t && a(t)
    } else {
        var l = {
            success: function(t) {
                if ("video" === e) var l = t[0].link.split("dl=0").join("dl=1");
                else var l = t[0].link.split("dl=0").join("raw=1");
                a(l)
            },
            cancel: function() {},
            linkType: "preview",
            multiselect: !1
        };
        "image" === e ? l.extensions = [".jpg", ".jpeg", ".png", ".gif"] : "video" === e ? l.extensions = [".mp4"] : "docs" === e && (l.extensions = [".docx"]), Dropbox.choose(l)
    }
}

function formBuilder(e, a, t) {
    t !== !1 && (t = !0);
    var l = "",
        s = "";
    switch (s = e.placeholder ? e.placeholder : e.label, Array.isArray(e) && (console.log("currentPage", database.currentPage), $.each(e, function(e, t) {
            l += '<div class="form-group">', t.label && (l += "<label>" + t.label + "</label>"), l += formBuilder(t, a), l += "</div>"
        })), e.type) {
        case "textarea":
            l += '<textarea class="form-control input-xs" placeholder="' + s + '" name="' + e.label + '">' + (a[e.label] || "") + "</textarea>";
            break;
        case "select":
            var o = "";
            $.each(e.options, function(t, l) {
                o += a[e.label] === l ? "<option selected>" + l + "</option>" : "<option>" + l + "</option>"
            }), l += '<select class="form-control input-xs" name="' + e.label + '">   <option value="">' + s + "..</option>" + o + "</select>";
            break;
        case "image":
            l += t ? '<button type="button" class="btn btn-lg btn-block dp-image-chooser" key="' + e.label + '" style="height: 100px; background: url(' + (a[e.label] || "data:image/gif;base64,R0lGODlhAQABAIAAAHd3dwAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==") + ') center center no-repeat / cover;"></button>' : '<img key="' + e.label + '" src="' + (a[e.label] || "data:image/gif;base64,R0lGODlhAQABAIAAAHd3dwAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==") + '" class="img-rounded dp-chooser"/>';
            break;
        case "image-btn":
            break;
        case "video":
            break;
        case "set":
            break;
        case "table":
            var r = "";
            $.each(e.schema, function(e, a) {
                r += "<th>" + a.label + "</th>"
            });
            var n = "";
            $.each(a, function(a, t) {
                n += '<tr list-id="' + t._id + '">', $.each(e.schema, function(e, a) {
                    n += "<td>" + formBuilder(a, t, !1) + "</td>"
                }), n += '<td class="text-center">   <a href="#" class="btn btn-xs list-delete"><i class="fa fa-trash"></i></a></td>', n += "</tr>"
            }), l += '<div class="table-responsive">   <table class="table table-bordered table-striped table-hover table-cms">       <thead><tr>' + r + '           <th class="text-center" style="width: 68px;"><a href="#" class="btn btn-xs list-add"><i class="fa fa-plus"></i></a></th>       </tr></thead>       <tbody>' + n + "       </tbody>   </table></div>";
            break;
        case "richtext":
            l += t ? "<div contenteditable key='" + e.label + "'>" + (a[e.label] || "") + "</div>" : '<button type="button" class="btn btn-default btn-richtext" name="' + e.label + '"><i class="fa fa-pencil"></i> Richtext</button>';
            break;
        case "viewlink":
            l += '<a href="' + window.location.href.split("editor.php")[0] + a[e.label] + '" target="_blank">' + a[e.label] + "</a>";
            break;
        default:
            e.type && (l += '<input type="' + e.type + '" class="form-control input-xs" placeholder="' + s + '" name="' + e.label + '" value="' + (a[e.label] || "") + '"/>')
    }
    return l
}

function getDB(e) {
    for (var a = 0; a < database.db.length; a++)
        if (database.db[a].name.toLowerCase() === e.toLowerCase()) return database.db[a]
}

function getDBSchema(e) {
    for (var a = 0; a < database.db.length; a++)
        if (database.db[a].name.toLowerCase() === e.toLowerCase()) return database.db[a].schema
}

function getDBCollection(e) {
    for (var a = 0; a < database.db.length; a++)
        if (database.db[a].name.toLowerCase() === e.toLowerCase()) return database.db[a].collections
}

function editDB(e) {
    for (var a = 0; a < database.db.length; a++) {
        var t = database.db[a];
        e === t._id && (database.currentDB = t, $("#mdl-db-editor .modal-title").text(t.name), $("#mdl-db-editor .modal-body").html(formBuilder({
            type: "table",
            schema: t.schema
        }, t.collections)), $("#mdl-db-editor").modal("show"))
    }
}

function configDB(e) {
    for (var a = 0; a < database.db.length; a++) {
        var t = database.db[a];
        e === t._id && (database.currentDB = t, $("#mdl-db-editor .modal-title").text(t.name), $("#mdl-db-editor .modal-body").html(formBuilder({
            type: "table",
            schema: [{
                type: "select",
                label: "type",
                options: ["text", "number", "date", "email", "textarea", "richtext", "select", "image", "viewlink"]
            }, {
                type: "text",
                label: "label"
            }]
        }, t.schema)), $("#mdl-db-editor").modal("show"))
    }
}

function getDBRecord(e, a) {
    for (var t = 0; t < e.length; t++)
        if (a == e[t]._id) return e[t]
}

function saveToFile() {
    for (var e = $(".main").bfeditor("getContent"), a = 0; a < database.pages.length; a++) database.currentPage._id == database.pages[a]._id && (database.pages[a].template = e);
    var t = "app.db.js"; - 1 == t.indexOf(".") ? t += ".js" : "js" == t.split(".").pop().toLowerCase() || (t = t.split(".")[0] + ".js");
    var l = "var database = " + JSON.stringify(database, !0, 2);
    $.ajax({
        type: "post",
        url: "php/app.db.php",
        data: {
            db: l
        },
        success: function(e) {
            "success" === e ? toastr.success("Your website is now up-to-date", "Success!") : (toastr.error("Pls Try Again", "Failed!"), console.log("res", e))
        },
        error: function(e) {}
    })
}